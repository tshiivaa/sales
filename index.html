<script>
    const salesTableBody = document.querySelector('#salesTable tbody');
    const totalAmountDisplay = document.getElementById('totalAmount');
    const totalWithTaxDisplay = document.getElementById('totalWithTax');
    const debugOutput = document.getElementById('debugOutput');

    // Initialize global variables
    let salesData = [];
    let totalAmount = 0;
    let totalTaxAmount = 0;

    // Load data from localStorage
    function loadSalesData() {
        const savedData = JSON.parse(localStorage.getItem('sheinSalesData')) || [];
        if (savedData.length > 0) {
            salesData = savedData;
            salesData.forEach(sale => {
                totalAmount += sale.amount;
                totalTaxAmount += sale.amount * 4.7; // Tax rate of 4.7 times the amount
            });
        }
        updateTable();
    }

    // Save data to localStorage
    function saveSalesData() {
        localStorage.setItem('sheinSalesData', JSON.stringify(salesData));
    }

    // Update the table and totals
    function updateTable() {
        salesTableBody.innerHTML = '';
        salesData.forEach((sale, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${sale.name}</td>
                <td>${sale.phone}</td>
                <td>${sale.amount.toFixed(2)} EURO</td>
                <td>${sale.amountWithTax.toFixed(2)} DT</td>
                <td>
                    <button class="edit-btn" data-index="${index}">Edit</button>
                    <button class="delete-btn" data-index="${index}">Delete</button>
                </td>
            `;
            salesTableBody.appendChild(row);
        });

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', handleEdit);
        });
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', handleDelete);
        });

        // Update totals
        totalAmountDisplay.textContent = `Total Amount (No Tax): ${totalAmount.toFixed(2)} EURO`;
        totalWithTaxDisplay.textContent = `Total Tax Amount: ${totalTaxAmount.toFixed(2)} DT`;
    }

    // Handle form submission
    document.getElementById('salesForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent default form submission

        // Get input values
        const customerName = document.getElementById('customerName').value.trim();
        const customerPhone = document.getElementById('customerPhone').value.trim();
        const amountSpent = parseFloat(document.getElementById('amountSpent').value);

        // Validate phone number length
        if (!/^\d{1,8}$/.test(customerPhone)) {
            alert('Phone number must be up to 8 digits.');
            return;
        }

        // Ensure all fields are filled and valid
        if (customerName && customerPhone && !isNaN(amountSpent)) {
            const taxRate = 4.7; // Tax rate is 4.7 times the regular amount
            const taxOnly = amountSpent * taxRate; // Calculate only the tax portion
            const amountWithTax = amountSpent * taxRate; // Total amount with tax

            // Add sale to data array
            salesData.push({
                name: customerName,
                phone: customerPhone,
                amount: amountSpent,
                amountWithTax: amountWithTax
            });

            // Update totals
            totalAmount += amountSpent;
            totalTaxAmount += taxOnly;

            // Clear form fields
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('amountSpent').value = '';

            // Update table and save data
            updateTable();
            saveSalesData();

            // Debugging output
            console.log('Sales Data:', salesData);
            console.log('Total Amount (No Tax):', totalAmount);
            console.log('Total Tax Amount:', totalTaxAmount);
        } else {
            alert('Please fill in all fields correctly.');
        }
    });

    // Handle edit functionality
    function handleEdit(event) {
        const index = parseInt(event.target.dataset.index);
        if (index >= 0 && index < salesData.length) {
            const sale = salesData[index];

            // Populate form fields with current data
            document.getElementById('customerName').value = sale.name;
            document.getElementById('customerPhone').value = sale.phone;
            document.getElementById('amountSpent').value = sale.amount;

            // Remove the old entry
            totalAmount -= sale.amount;
            totalTaxAmount -= sale.amount * 4.7;
            salesData.splice(index, 1);

            // Update table and save data
            updateTable();
            saveSalesData();
        }
    }

    // Handle delete functionality
    function handleDelete(event) {
        const index = parseInt(event.target.dataset.index);
        if (index >= 0 && index < salesData.length) {
            const sale = salesData[index];

            // Remove the entry
            totalAmount -= sale.amount;
            totalTaxAmount -= sale.amount * 4.7;
            salesData.splice(index, 1);

            // Update table and save data
            updateTable();
            saveSalesData();
        }
    }

    // View raw data
    document.getElementById('viewData').addEventListener('click', () => {
        debugOutput.textContent = JSON.stringify(salesData, null, 2);
    });

    // Clear all data
    document.getElementById('clearData').addEventListener('click', () => {
        salesData = [];
        totalAmount = 0;
        totalTaxAmount = 0;
        salesTableBody.innerHTML = '';
        debugOutput.textContent = '';
        totalAmountDisplay.textContent = `Total Amount (No Tax): 0.00 EURO`;
        totalWithTaxDisplay.textContent = `Total Tax Amount: 0.00 DT`;

        // Clear data from localStorage
        localStorage.removeItem('sheinSalesData');
        console.log('All data cleared.');
    });

    // Export data as HTML
    document.getElementById('exportData').addEventListener('click', () => {
        let htmlContent = `
            <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Shein Sales Data</title>
                </head>
                <body>
                    <h1>Shein Sales Data</h1>
                    <table border="1">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Customer Name</th>
                                <th>Customer Phone</th>
                                <th>Amount Spent (DT)</th>
                                <th>Amount with Tax (DT)</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        salesData.forEach((sale, index) => {
            htmlContent += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${sale.name}</td>
                    <td>${sale.phone}</td>
                    <td>${sale.amount.toFixed(2)}</td>
                    <td>${sale.amountWithTax.toFixed(2)}</td>
                </tr>
            `;
        });

        htmlContent += `
                        </tbody>
                    </table>
                </body>
            </html>
        `;

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'shein_sales_data.html';
        a.click();
        URL.revokeObjectURL(url);
        console.log('Data exported as HTML.');
    });

    // Load data on page load
    loadSalesData();
</script>